# 用户管理系统

用户管理系统中，最基本的功能之一，就是用户登录功能。要实现用户名+密码登录的功能，最简单也最直观的想法就是直接创建一个 `users` 表，包含 `username` 和 `password` 两个字段，这样，就可以实现登录了：

|id	|username	|password	|nickname		| ....
|--	|---------	|--------	|------------	|------
|1	|Sheldon	|a1b2c3d4	|Sheldon Chen	| ....
|2	|Ada		|a1b2c3d4	|Ada Wang		| ....

那现在的问题是，如果要让用户通过第三方登录，比如微博登录或微信登录，怎么集成进来呢？

以微博登录为例，由于微博使用 OAuth2 协议登录，所以，一个登录用户会包含他的微博身份的 ID，一个 access token 用于代表该用户访问微博的 API 和一个过期时间。

要集成微博登录，可能大家立刻会想到把 `users` 表扩展几列，记录下微博的信息：

|id	|username	|password	|nickname		| weibo_id	| weibo_access_token	|weibo_expires	|
|--	|---------	|--------	|------------	|----------	|--------------------	|-------------	|
|1	|Sheldon	|a1b2c3d4	|Sheldon Chen	| w1234567	| token_1234567			|63370			|
|2	|Ada		|a1b2c3d4	|Ada Wang		| w2345678	| token_2345678			|63370			|

如果再需要微信登录的话， `users` 表又需要加 3 列，如果这样扩展下去，别说维护代码了，时间都贡献给数据库表上面了。

那怎样才能设计出一个灵活的登录系统呢？

如果换个角度来考虑用户登录，当用户以任意一种方式登录成功后，我们都是读取到 `users` 表里的一条对应的记录，这实际上是用户的信息，而登录的过程实际只是为了验证用户，无论是本地用户用密码验证，还是委托第三方登录，这个过程的本质上都是验证。

所以，如果把用户信息和验证信息分开，就会符合这实际的情况了。在 `users` 表里只存储用户信息：

|id	|nickname		| ....
|--	|------------	|------
|1	|Sheldon Chen	| ....
|2	|Ada Wang		| ....

而通过用户名密码登录可视为一种验证的方式，利用 `local_auth` 表进行维护：

|id	|user_id 		| username	| password		|
|--	|------------	|---------	|-----------	|
|1	|1				| Sheldon	|a1b2c3d4		|
|2	|Ada Wang		| Ada		|a1b2c3d4		|

通过微博登录可视为另一种认证方式，利用 `o_auth_2` 表进行维护：

|id	|user_id	| weibo_id	| weibo_access_token	|weibo_expires	|
|--	|---------	|----------	|--------------------	|-------------	|
|1	|1			| w1234567	| token_1234567			|63370			|
|2	|2			| w2345678	| token_2345678			|63370			|

如果要添加另一种 OAuth 登录，比如说微信登录，增加一个表就可以了。

如果要增加一种新的登录方式，比如说SAML，那就再加一种类型的表。

有些网站需要 API 访问， API 可以使用 api_key 和 api_secret 来认证，可是怎样把一个 API 访问关联到一个用户？方法还是增加一个 `api_auth` 的表：

 id | user_id 	| api_key  | api_secret
----|---------	|----------|------------
 1 	| 1      	| a-012345 | xxxxxxxxxx
 1 	| 1      	| a-234567 | xxxxxxxxxx
 
 每一种 `X_auth` 表都存储了用户的登录认证信息，并通过 `user_id` 关联到 `users` 表。这样一来，不但登录过程简化了，而且一个用户可以使用多种方式登录。只要登录成功，拿到了 `user_id`，最后读取 `users` 表是为了获取用户的信息，这样读出来的数据也更安全，因为 `users` 不包含用户密码，不会因为暴露 API 而不小心把密码给泄露出去。
